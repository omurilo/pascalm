name: Bison Flex Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y flex gcc libfl-dev bison

    - name: Find and test all Flex/Bison modules
      run: |
        find exercises/bison/ -type f \( -name "*.lex" -or -name "*.l" -or -name "*.y" \) -exec dirname {} \; | sort -u | while read module; do
          echo "Testing module: $module"
          
          cd "$module" || continue

          mkdir -p $HOME/bison_build

          lfiles=$(find "$module" -maxdepth 1 \( -name "*.l" -or -name "*.lex" \))
          yfiles=$(find "$module" -maxdepth 1 \( -name "*.y" \))

          if [ -z "$lfiles" ] || [ -z "$yfiles" ]; then
            echo "No .l or .y files found in $module, skipping"
            cd - >/dev/null
            continue
          fi

          filename=$(basename "$yfiles" .y)

          bison -d "$yfiles" -o "$filename.tab.c"
          flex "$lfiles"

          if [ ! -f "lex.yy.c" ] || [ ! -f "$filename.tab.c" ]; then
            echo "Bison/Flex output missing, skipping $module"
            cd - >/dev/null
            continue
          fi

          g++ -I. -o parser lex.yy.c "$filename.tab.c"

          input_file=$(find . -maxdepth 1 -name "*.test.txt")
          expected_output=$(find . -maxdepth 1 -name "*.output.txt")

          if [ ! -f "$input_file" ] || [ ! -f "$expected_output" ]; then
            echo "Missing test files in $module, skipping"
            cd - >/dev/null
            continue
          fi

          ./parser < "$input_file" > output.txt
          diff output.txt "$expected_output" || exit 1

          # Clean up
          rm -f parser lex.yy.c "$filename.tab.c" "$filename.tab.h" output.txt
          cd - >/dev/null
        done
    - name: Check test results
      run: |
        if [ $? -eq 0 ]; then
          echo "All tests passed!"
        else
          echo "Test failed!"
          exit 1
        fi

